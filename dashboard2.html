<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPA è€ƒå®˜ä¸€è‡´æ€§æ¼”ç·´ - è©•é‡ç¾æ³å„€è¡¨æ¿</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        /* æ ¸å¿ƒæš–è‰²ç³» */
        :root {
            --primary-color: #FF7F50; /* çŠç‘šæ©˜ - ä¸»è¦æš–è‰² */
            --secondary-color: #FFA500; /* æ©˜è‰² - è¼”åŠ©æš–è‰² */
            --light-bg: #FFF8E1; /* æ·ºå¥¶æ²¹é»ƒ - æ´»æ½‘èƒŒæ™¯ */
            --dark-text: #333333;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', 'Microsoft JhengHei', sans-serif;
            background-color: var(--light-bg);
            color: var(--dark-text);
            padding-top: 20px;
        }

        .header-section {
            background: linear-gradient(90deg, #FFD700 0%, var(--primary-color) 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 30px;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
        }

        h1, h2 {
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s ease;
            height: 100%; /* ç¢ºä¿å¡ç‰‡é«˜åº¦ä¸€è‡´ */
        }
        
        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            background-color: var(--secondary-color);
            color: white;
            font-weight: 600;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            padding: 1rem;
        }

        .chart-container {
            padding: 10px;
        }

        /* æ´»æ½‘ç”Ÿå‹•çš„ç­‰ç´šé¡è‰² */
        .level-color-4 { color: #28a745; font-weight: bold; } /* Level 4: ç¶ è‰² (å‹ä»») */
        .level-color-3c { color: #FFC107; font-weight: bold; } /* Level 3c: ç¥ç€ (éœ€ç›£ç£) */
        .level-color-3b { color: #DC3545; font-weight: bold; } /* Level 3b: ç´…è‰² (ä¸å‹ä»») */
        
        /* å„€è¡¨æ¿åˆ†éš”ç·š */
        .section-divider {
            border-top: 3px dashed var(--primary-color);
            margin: 40px 0;
            opacity: 0.5;
        }
    </style>
</head>
<body>

    <div class="container-fluid">
        <header class="header-section text-center">
            <h1>âœ¨ EPA è€ƒå®˜ä¸€è‡´æ€§æ¼”ç·´ - è©•é‡ç¾æ³å„€è¡¨æ¿ âœ¨</h1>
            <p class="lead">æ•¸æ“šé©…å‹•ï¼Œæ´»æ½‘å±•ç¾ï¼šå­¸å“¡ä¿¡è³´ç­‰ç´šã€æ•™å¸«å›é¥‹èˆ‡èª²ç¨‹å»ºè­°åˆ†æ</p>
        </header>

        <main>
            <div class="row mb-4">
                <div class="col-lg-12">
                    <h2 class="text-center mb-4"><span style="color: var(--primary-color);">ğŸ”¥</span> æ•´é«”ä¿¡è³´ç­‰ç´šåˆ†å¸ƒæ¦‚æ³</h2>
                </div>
                <div class="col-lg-6 col-md-12 mb-4">
                    <div class="card">
                        <div class="card-header text-center">ğŸ† ç¸½é«”ä»»å‹™è©•ä¼° (æ‰€æœ‰è€ƒå®˜) åˆ†å¸ƒ</div>
                        <div class="card-body chart-container" id="overallTaskChart"></div>
                    </div>
                </div>
                <div class="col-lg-6 col-md-12 mb-4">
                    <div class="card">
                        <div class="card-header text-center">â­ å¹³å‡ä¿¡è³´ç­‰ç´š (ç¸½è¦½)</div>
                        <div class="card-body chart-container" id="averageLevelGauge"></div>
                    </div>
                </div>
            </div>

            <hr class="section-divider">

            <div class="row mb-4">
                <div class="col-lg-12">
                    <h2 class="text-center mb-4"><span style="color: var(--primary-color);">ğŸ’¡</span> é—œéµ EPA ä»»å‹™è©•åˆ†ç´°é …åˆ†æ</h2>
                </div>
                <div class="col-lg-12 mb-4">
                    <div class="card">
                        <div class="card-header text-center">ğŸš€ å„é … EPA ä»»å‹™å¹³å‡ä¿¡è³´ç­‰ç´šæ¯”è¼ƒ</div>
                        <div class="card-body chart-container" id="epaDetailChart"></div>
                    </div>
                </div>
            </div>

            <hr class="section-divider">

            <div class="row mb-4">
                <div class="col-lg-12">
                    <h2 class="text-center mb-4"><span style="color: var(--primary-color);">ğŸ’–</span> æ•™å¸«å›é¥‹èˆ‡æ»¿æ„åº¦</h2>
                </div>
                <div class="col-lg-6 col-md-12 mb-4">
                    <div class="card">
                        <div class="card-header text-center">ğŸ“Š æ•™å¸«å°è©•é‡æ»¿æ„ç¨‹åº¦åˆ†å¸ƒ</div>
                        <div class="card-body chart-container" id="satisfactionChart"></div>
                    </div>
                </div>
                <div class="col-lg-6 col-md-12 mb-4">
                    <div class="card">
                        <div class="card-header text-center">ğŸ—£ï¸ èª²ç¨‹å»ºè­°é¡å‹åˆ†å¸ƒ</div>
                        <div class="card-body chart-container" id="courseTypeChart"></div>
                    </div>
                </div>
            </div>
            
        </main>

        <footer class="text-center py-3 mt-4" style="color: var(--dark-text); opacity: 0.7;">
            <p>è³‡æ–™åˆ†æèˆ‡è¦–è¦ºåŒ–ç”Ÿæˆ by AI ğŸ¤–</p>
        </footer>
    </div>

    <script>
        // 1. å…§åµŒ CSV è³‡æ–™ï¼ˆç‚ºäº†æ–¹ä¾¿åœ¨å–®ä¸€ HTML æª”æ¡ˆä¸­é‹è¡Œï¼‰
        // æ•¸æ“šä¾†æºï¼š114.11.13 è€ƒå®˜ä¸€è‡´æ€§æ¼”ç·´(EPA) (å›è¦†) (1).xlsx - å ±åè³‡æ–™.csv
        const rawData = [
            "æ™‚é–“æˆ³è¨˜,1.ä¿¡è³´ç­‰ç´šè©•åˆ† ( ä¸‹æ¬¡é‡åˆ°é¡ä¼¼æƒ…å¢ƒæ™‚ï¼Œæ‚¨èªç‚ºæ­¤å­¸å“¡å‹ä»»ç¨‹åº¦å¦‚ä½•) [ç¢ºèªç‡Ÿé¤Šç…§è­·éœ€æ±‚ï¼Œå¿…è¦æ™‚èˆ‡é†«è­·åœ˜éšŠæºé€š],1.ä¿¡è³´ç­‰ç´šè©•åˆ† ( ä¸‹æ¬¡é‡åˆ°é¡ä¼¼æƒ…å¢ƒæ™‚ï¼Œæ‚¨èªç‚ºæ­¤å­¸å“¡å‹ä»»ç¨‹åº¦å¦‚ä½•) [æ”¶é›†ç‡Ÿé¤Šè©•ä¼°å®¢è§€è³‡è¨Š],1.ä¿¡è³´ç­‰ç´šè©•åˆ† ( ä¸‹æ¬¡é‡åˆ°é¡ä¼¼æƒ…å¢ƒæ™‚ï¼Œæ‚¨èªç‚ºæ­¤å­¸å“¡å‹ä»»ç¨‹åº¦å¦‚ä½•) [æŒ‰ç…§é†«é™¢è¦ç¯„é€²è¡Œç—…äººè¾¨è­˜ï¼Œä¸¦è¡¨æ˜è‡ªå·±èº«ä»½],1.ä¿¡è³´ç­‰ç´šè©•åˆ† ( ä¸‹æ¬¡é‡åˆ°é¡ä¼¼æƒ…å¢ƒæ™‚ï¼Œæ‚¨èªç‚ºæ­¤å­¸å“¡å‹ä»»ç¨‹åº¦å¦‚ä½•) [é€²è¡Œè¨ªè«‡ï¼Œä»¥è©•ä¼°ç‡Ÿé¤Šæ”å–é‡èˆ‡ç…§è­·è³‡æº],1.ä¿¡è³´ç­‰ç´šè©•åˆ† ( ä¸‹æ¬¡é‡åˆ°é¡ä¼¼æƒ…å¢ƒæ™‚ï¼Œæ‚¨èªç‚ºæ­¤å­¸å“¡å‹ä»»ç¨‹åº¦å¦‚ä½•) [åˆ¤å®šç‡Ÿé¤Šè¨ºæ–·],1.ä¿¡è³´ç­‰ç´šè©•åˆ† ( ä¸‹æ¬¡é‡åˆ°é¡ä¼¼æƒ…å¢ƒæ™‚ï¼Œæ‚¨èªç‚ºæ­¤å­¸å“¡å‹ä»»ç¨‹åº¦å¦‚ä½•) [æ“¬å®šç‡Ÿé¤Šæ²»ç™‚ç›®æ¨™ï¼Œæä¾›ç‡Ÿé¤Šä»‹å…¥è¨ˆç•«],1.ä¿¡è³´ç­‰ç´šè©•åˆ† ( ä¸‹æ¬¡é‡åˆ°é¡ä¼¼æƒ…å¢ƒæ™‚ï¼Œæ‚¨èªç‚ºæ­¤å­¸å“¡å‹ä»»ç¨‹åº¦å¦‚ä½•) [å®Œæˆç‡Ÿé¤Šç—…æ­·ç´€éŒ„],1.ä¿¡è³´ç­‰ç´šè©•åˆ† ( ä¸‹æ¬¡é‡åˆ°é¡ä¼¼æƒ…å¢ƒæ™‚ï¼Œæ‚¨èªç‚ºæ­¤å­¸å“¡å‹ä»»ç¨‹åº¦å¦‚ä½•) [*æ•´é«”ä»»å‹™è©•ä¼°*],\"2.è³ªæ€§å›é¥‹(è‡¨åºŠæ•™å¸«) ~è«‹çµ¦äºˆå­¸å“¡å»ºè­°~\",3.æ•™å¸«å°æœ¬æ¬¡è©•é‡æ»¿æ„ç¨‹åº¦,**é‡å°æœ¬æ¬¡å·¥ä½œåŠï¼Œæœ‰ä»€éº¼å»ºè­°å‘¢? ,**æ˜å¹´åº¦èª²ç¨‹ï¼Œæƒ³è½ä»€éº¼é¡å‹å‘¢?(å¯è¤‡é¸å–”~),**è«‹ä¾æ“šç¬¬5é¡Œå¡«ç­”ï¼Œæ¨è–¦èª²ç¨‹å…§å®¹æˆ–äººé¸~\n",
            "2025-11-13 13:58:30,Level 3c,Level 3c,Level 4,Level 3c,Level 3c,Level 3c,Level 3c,Level 3c,\"é›–ç„¶å®¶å±¬å•å®Œå®¶å±¬ç–‘å•ï¼Œå¯ä»¥å†å¹«ä»–æ•´ç†æ›´æ¸…æ¥šï¼Œå¦å¤–ç¾éšæ®µè‚‰é¡ç„¡æ³•å’€åš¼ååš¥ï¼Œæ˜¯å¦å¯ä»¥èª¿æ•´ç‚ºå‰ç¢æˆ–æº«å’Œé£²é£ŸIIæˆ–æ˜¯æ¿ƒç²¥\",7,ç„¡,\"A.å°ˆæ¥­æå‡(é‡ç—‡ã€å…’ç§‘ã€IBD..., B.é†«å­¸äººæ–‡(æ–‡å­¸ã€éŸ³æ¨‚ã€é›»å½±ã€å€«ç†ã€æ•˜äº‹é†«å­¸ã€å“²å­¸...\",å…’ç§‘è¼ƒä¸ç†Ÿï¼Œå¯ä»¥è«‹é€™é¡å°ˆå®¶ä¾†ä¸Šèª²ã€‚é†«å­¸äººæ–‡çš„å“²å­¸æ„Ÿè¦ºè »æœ‰è¶£çš„ï¼Œä¹‹å‰éƒ½æ²’æœ‰æ¥è§¸é\n",
            "2025-11-13 13:59:40,Level 4,Level 3c,Level 3c,Level 3b,Level 4,Level 3b,Level 3c,Level 3c,è¡›æ•™æ‰‹å†Šè¦è®€ç†Ÿï¼Œå¯é‹ç”¨è¡›æ•™å–®å¼µ,7,å½±ç‰‡æ¸…æ™°åº¦,\"A.å°ˆæ¥­æå‡(é‡ç—‡ã€å…’ç§‘ã€IBD..., B.é†«å­¸äººæ–‡(æ–‡å­¸ã€éŸ³æ¨‚ã€é›»å½±ã€å€«ç†ã€æ•˜äº‹é†«å­¸ã€å“²å­¸...\",ç„¡\n",
            "2025-11-13 14:00:15,Level 3c,Level 3b,Level 4,Level 3b,Level 3c,Level 3c,Level 3c,Level 3c,æ²’æœ‰ç¢ºèªåœ˜éšŠæºé€šï¼Œå¯å¤šä½¿ç”¨è¡›æ•™å–®å¼µ,8,ç„¡,\"A.å°ˆæ¥­æå‡(é‡ç—‡ã€å…’ç§‘ã€IBD..., B.é†«å­¸äººæ–‡(æ–‡å­¸ã€éŸ³æ¨‚ã€é›»å½±ã€å€«ç†ã€æ•˜äº‹é†«å­¸ã€å“²å­¸...\",ä¾å°ˆæ¥­é¸æ“‡äººé¸å³å¯ï½ï½\n",
            "2025-11-13 14:00:17,Level 3b,Level 3b,Level 3c,Level 3b,Level 3b,Level 3b,Level 3c,Level 3b,å¤šè·Ÿç—…äººå®¶å±¬äº’å‹•ï¼Œçµ¦äºˆè¡›æ•™å–®å¼µ,7,ç„¡,\"A.å°ˆæ¥­æå‡(é‡ç—‡ã€å…’ç§‘ã€IBD..., B.é†«å­¸äººæ–‡(æ–‡å­¸ã€éŸ³æ¨‚ã€é›»å½±ã€å€«ç†ã€æ•˜äº‹é†«å­¸ã€å“²å­¸...\",é†«å­¸äººæ–‡\n",
            "2025-11-13 14:01:21,Level 3c,Level 3c,Level 4,Level 4,Level 3c,Level 4,Level 4,Level 4,æ•´é«”è¡¨ç¾æµæš¢ï¼Œè¡›æ•™å…§å®¹å¯æ›´ä»”ç´°èªªæ˜,9,ç„¡,\"A.å°ˆæ¥­æå‡(é‡ç—‡ã€å…’ç§‘ã€IBD..., B.é†«å­¸äººæ–‡(æ–‡å­¸ã€éŸ³æ¨‚ã€é›»å½±ã€å€«ç†ã€æ•˜äº‹é†«å­¸ã€å“²å­¸...\",ç„¡\n",
            "2025-11-13 14:02:40,Level 4,Level 4,Level 4,Level 4,Level 4,Level 4,Level 4,Level 4,ç„¡,9,ç„¡,\"A.å°ˆæ¥­æå‡(é‡ç—‡ã€å…’ç§‘ã€IBD..., B.é†«å­¸äººæ–‡(æ–‡å­¸ã€éŸ³æ¨‚ã€é›»å½±ã€å€«ç†ã€æ•˜äº‹é†«å­¸ã€å“²å­¸...\",ç„¡\n",
            "2025-11-13 14:03:19,Level 4,Level 4,Level 4,Level 4,Level 4,Level 4,Level 4,Level 4,æ•´é«”è¡¨ç¾æµæš¢ï¼Œè¡›æ•™å…§å®¹å¯æ›´ä»”ç´°èªªæ˜,9,ç„¡,\"A.å°ˆæ¥­æå‡(é‡ç—‡ã€å…’ç§‘ã€IBD..., B.é†«å­¸äººæ–‡(æ–‡å­¸ã€éŸ³æ¨‚ã€é›»å½±ã€å€«ç†ã€æ•˜äº‹é†«å­¸ã€å“²å­¸...\",é‡ç—‡ã€é†«å­¸å€«ç†\n",
            "2025-11-13 14:03:59,Level 3c,Level 3c,Level 3c,Level 3c,Level 3c,Level 3c,Level 3c,Level 3c,å¯ä»¥å†æ¸…æ¥šèªªæ˜é£²é£Ÿå»ºè­°,8,ç„¡,\"A.å°ˆæ¥­æå‡(é‡ç—‡ã€å…’ç§‘ã€IBD..., B.é†«å­¸äººæ–‡(æ–‡å­¸ã€éŸ³æ¨‚ã€é›»å½±ã€å€«ç†ã€æ•˜äº‹é†«å­¸ã€å“²å­¸...\",é†«å­¸äººæ–‡\n",
            "2025-11-13 14:04:30,Level 3c,Level 3c,Level 4,Level 4,Level 3c,Level 4,Level 4,Level 4,æ•´é«”è¡¨ç¾æµæš¢ï¼Œè¡›æ•™å…§å®¹å¯æ›´ä»”ç´°èªªæ˜,9,ç„¡,\"A.å°ˆæ¥­æå‡(é‡ç—‡ã€å…’ç§‘ã€IBD..., B.é†«å­¸äººæ–‡(æ–‡å­¸ã€éŸ³æ¨‚ã€é›»å½±ã€å€«ç†ã€æ•˜äº‹é†«å­¸ã€å“²å­¸...\",ç„¡\n",
            "2025-11-13 14:04:47,Level 3c,Level 3c,Level 3c,Level 3c,Level 3c,Level 3c,Level 3c,Level 3c,æ²’æœ‰ç¢ºèªåœ˜éšŠæºé€šï¼Œå¯å¤šä½¿ç”¨è¡›æ•™å–®å¼µ,8,ç„¡,\"A.å°ˆæ¥­æå‡(é‡ç—‡ã€å…’ç§‘ã€IBD..., B.é†«å­¸äººæ–‡(æ–‡å­¸ã€éŸ³æ¨‚ã€é›»å½±ã€å€«ç†ã€æ•˜äº‹é†«å­¸ã€å“²å­¸...\",å…’ç§‘\n",
            "2025-11-13 14:04:54,Level 4,Level 4,Level 4,Level 4,Level 4,Level 4,Level 4,Level 4,ç„¡,9,ç„¡,\"A.å°ˆæ¥­æå‡(é‡ç—‡ã€å…’ç§‘ã€IBD..., B.é†«å­¸äººæ–‡(æ–‡å­¸ã€éŸ³æ¨‚ã€é›»å½±ã€å€«ç†ã€æ•˜äº‹é†«å­¸ã€å“²å­¸...\",é‡ç—‡\n",
            "2025-11-13 14:05:40,Level 4,Level 4,Level 4,Level 4,Level 4,Level 4,Level 4,Level 4,ç„¡,9,ç„¡,\"A.å°ˆæ¥­æå‡(é‡ç—‡ã€å…’ç§‘ã€IBD..., B.é†«å­¸äººæ–‡(æ–‡å­¸ã€éŸ³æ¨‚ã€é›»å½±ã€å€«ç†ã€æ•˜äº‹é†«å­¸ã€å“²å­¸...\",ç„¡\n",
            "2025-11-13 14:05:59,Level 4,Level 4,Level 4,Level 4,Level 4,Level 4,Level 4,Level 4,ç„¡,9,ç„¡,\"A.å°ˆæ¥­æå‡(é‡ç—‡ã€å…’ç§‘ã€IBD..., B.é†«å­¸äººæ–‡(æ–‡å­¸ã€éŸ³æ¨‚ã€é›»å½±ã€å€«ç†ã€æ•˜äº‹é†«å­¸ã€å“²å­¸...\",ç„¡\n",
            "2025-11-13 14:06:50,Level 3c,Level 3c,Level 3c,Level 3c,Level 3c,Level 3c,Level 3c,Level 3c,å¤šè·Ÿç—…äººå®¶å±¬äº’å‹•ï¼Œçµ¦äºˆè¡›æ•™å–®å¼µ,7,ç„¡,\"A.å°ˆæ¥­æå‡(é‡ç—‡ã€å…’ç§‘ã€IBD..., B.é†«å­¸äººæ–‡(æ–‡å­¸ã€éŸ³æ¨‚ã€é›»å½±ã€å€«ç†ã€æ•˜äº‹é†«å­¸ã€å“²å­¸...\",ç„¡\n"
        ];
        
        // 2. è³‡æ–™æ¸…ç†èˆ‡è½‰æ›
        const lines = rawData.join('').trim().split('\n');
        const headerRow = lines[0].split(',').map(h => h.replace(/\"/g, '').trim());
        const dataRows = lines.slice(1).map(line => {
            // ä½¿ç”¨æ­£è¦è¡¨é”å¼è™•ç†å¸¶å¼•è™Ÿçš„æ¬„ä½ï¼Œç¢ºä¿é€—è™Ÿä¸è¢«èª¤åˆ¤
            const values = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current.trim()); // åŠ ä¸Šæœ€å¾Œä¸€å€‹æ¬„ä½
            return values;
        });

        // å»ºç«‹ä¸€å€‹è³‡æ–™è™•ç†å‡½æ•¸ï¼Œå°‡ Level è½‰æ›ç‚ºæ•¸å­—
        const levelToNum = (level) => {
            switch (level.toLowerCase()) {
                case 'level 4': return 4;
                case 'level 3c': return 3.5;
                case 'level 3b': return 3.0;
                default: return 0;
            }
        };

        // 3. åœ–è¡¨æ•¸æ“šæº–å‚™
        
        // --- 3.1 ç¸½é«”ä»»å‹™è©•ä¼° (æœ€å¾Œä¸€é …è©•åˆ†) ---
        const overallTaskCol = headerRow.findIndex(h => h.includes('*æ•´é«”ä»»å‹™è©•ä¼°*'));
        const overallTaskScores = dataRows.map(row => row[overallTaskCol]);
        
        const overallCounts = overallTaskScores.reduce((acc, level) => {
            acc[level] = (acc[level] || 0) + 1;
            return acc;
        }, {});
        
        const overallData = {
            levels: Object.keys(overallCounts).sort((a, b) => levelToNum(a) - levelToNum(b)),
            counts: Object.keys(overallCounts).sort((a, b) => levelToNum(a) - levelToNum(b)).map(k => overallCounts[k])
        };

        // --- 3.2 EPA ç´°é …ä»»å‹™å¹³å‡ç­‰ç´š ---
        const epaCols = headerRow.slice(1, overallTaskCol); // æ’é™¤æ™‚é–“æˆ³è¨˜ï¼Œå–åˆ°æ•´é«”ä»»å‹™å‰
        
        const epaAverages = epaCols.map((col, index) => {
            const scores = dataRows.map(row => levelToNum(row[index + 1])); // +1 å› ç‚ºå¾ç¬¬äºŒæ¬„é–‹å§‹
            const sum = scores.reduce((a, b) => a + b, 0);
            return {
                task: col.split('[')[1].replace(']', '').trim(), // æ“·å–æ–¹æ‹¬è™Ÿå…§çš„ä»»å‹™åç¨±
                average: sum / scores.length
            };
        });

        // --- 3.3 æ•™å¸«æ»¿æ„åº¦ ---
        const satisfactionCol = headerRow.findIndex(h => h.includes('3.æ•™å¸«å°æœ¬æ¬¡è©•é‡æ»¿æ„ç¨‹åº¦'));
        const satisfactionScores = dataRows.map(row => parseInt(row[satisfactionCol]));
        
        const satisfactionCounts = satisfactionScores.reduce((acc, score) => {
            acc[score] = (acc[score] || 0) + 1;
            return acc;
        }, {});
        
        const satisfactionData = {
            scores: Object.keys(satisfactionCounts).map(Number).sort((a, b) => a - b),
            counts: Object.keys(satisfactionCounts).map(Number).sort((a, b) => a - b).map(k => satisfactionCounts[k])
        };

        // --- 3.4 èª²ç¨‹å»ºè­°é¡å‹ ---
        const courseTypeCol = headerRow.findIndex(h => h.includes('**æ˜å¹´åº¦èª²ç¨‹ï¼Œæƒ³è½ä»€éº¼é¡å‹å‘¢?'));
        const courseTypeResponses = dataRows.map(row => row[courseTypeCol]);
        
        const typeCounts = {
            'A.å°ˆæ¥­æå‡': 0,
            'B.é†«å­¸äººæ–‡': 0
        };
        
        courseTypeResponses.forEach(response => {
            if (response.includes('A.å°ˆæ¥­æå‡')) {
                typeCounts['A.å°ˆæ¥­æå‡']++;
            }
            if (response.includes('B.é†«å­¸äººæ–‡')) {
                typeCounts['B.é†«å­¸äººæ–‡']++;
            }
        });


        // 4. Plotly åœ–è¡¨ç¹ªè£½å‡½æ•¸

        // 4.1 ç¸½é«”ä»»å‹™è©•ä¼°é•·æ¢åœ–
        function plotOverallTaskChart() {
            const data = [{
                x: overallData.levels,
                y: overallData.counts,
                type: 'bar',
                marker: {
                    color: overallData.levels.map(level => {
                        if (level === 'Level 4') return '#28a745'; // ç¶ è‰²
                        if (level === 'Level 3c') return '#FFC107'; // ç¥ç€
                        if (level === 'Level 3b') return '#DC3545'; // ç´…è‰²
                        return '#6C757D';
                    })
                },
                hovertemplate: 'ä¿¡è³´ç­‰ç´š: %{x}<br>æ¬¡æ•¸: %{y}<extra></extra>'
            }];

            const layout = {
                title: false, // æ¨™é¡Œç§»è‡³ Card Header
                xaxis: { title: 'ä¿¡è³´ç­‰ç´š (Level)', fixedrange: true },
                yaxis: { title: 'æ¬¡æ•¸', fixedrange: true, tick0: 0, dtick: 1, rangemode: 'tozero' },
                margin: { l: 40, r: 20, t: 20, b: 50 },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white'
            };

            Plotly.newPlot('overallTaskChart', data, layout, { responsive: true, displayModeBar: false });
        }

        // 4.2 å¹³å‡ä¿¡è³´ç­‰ç´šå„€è¡¨
        function plotAverageLevelGauge() {
            const allScores = dataRows.flatMap((row, rowIndex) => 
                row.slice(1, overallTaskCol).map(level => levelToNum(level))
            ).filter(score => score > 0);
            
            const totalAverage = allScores.reduce((a, b) => a + b, 0) / allScores.length;
            const avgDisplay = totalAverage.toFixed(2);

            const data = [{
                type: 'indicator',
                mode: 'gauge+number',
                value: totalAverage,
                title: { text: `ç¸½å¹³å‡åˆ†æ•¸: ${avgDisplay}` },
                gauge: {
                    axis: { range: [3, 4], tickwidth: 1, tickcolor: "darkblue" },
                    bar: { color: "#FF7F50" }, // çŠç‘šæ©˜
                    bgcolor: "white",
                    steps: [
                        { range: [3.0, 3.2], color: "#DC3545" }, // Level 3b å€é–“
                        { range: [3.2, 3.6], color: "#FFC107" }, // Level 3c å€é–“
                        { range: [3.6, 4.0], color: "#28a745" }  // Level 4 å€é–“
                    ],
                    threshold: {
                        line: { color: "red", width: 4 },
                        thickness: 0.75,
                        value: totalAverage
                    }
                }
            }];

            const layout = {
                margin: { t: 50, b: 20, l: 30, r: 30 },
                paper_bgcolor: 'white',
                font: { color: var('--dark-text'), family: 'å¾®è»Ÿæ­£é»‘é«”' }
            };

            Plotly.newPlot('averageLevelGauge', data, layout, { responsive: true, displayModeBar: false });
        }

        // 4.3 EPA ç´°é …ä»»å‹™é•·æ¢åœ–
        function plotEpaDetailChart() {
            const sortedAverages = epaAverages.sort((a, b) => a.average - b.average);

            const data = [{
                x: sortedAverages.map(d => d.average),
                y: sortedAverages.map(d => d.task),
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: sortedAverages.map(d => {
                        if (d.average >= 3.6) return '#28a745'; // Level 4 å€é–“ (ç¶ è‰²)
                        if (d.average >= 3.2) return '#FFC107'; // Level 3c å€é–“ (ç¥ç€)
                        return '#DC3545'; // Level 3b å€é–“ (ç´…è‰²)
                    })
                },
                text: sortedAverages.map(d => d.average.toFixed(2)),
                textposition: 'outside',
                hovertemplate: 'ä»»å‹™: %{y}<br>å¹³å‡ç­‰ç´š: %{x:.2f}<extra></extra>'
            }];

            const layout = {
                title: false,
                xaxis: { title: 'å¹³å‡ä¿¡è³´ç­‰ç´š (3.0-4.0)', range: [3.0, 4.0], fixedrange: true },
                yaxis: { automargin: true, fixedrange: true },
                margin: { l: 200, r: 20, t: 20, b: 50 },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                height: 500 // ç¢ºä¿æ‰€æœ‰æ¨™ç±¤éƒ½èƒ½é¡¯ç¤º
            };

            Plotly.newPlot('epaDetailChart', data, layout, { responsive: true, displayModeBar: false });
        }

        // 4.4 æ•™å¸«æ»¿æ„åº¦åœ“é¤…åœ–
        function plotSatisfactionChart() {
            const data = [{
                values: satisfactionData.counts,
                labels: satisfactionData.scores.map(s => `${s} åˆ† (æ»¿æ„åº¦)`),
                type: 'pie',
                hole: 0.4, // ç”œç”œåœˆåœ–
                marker: {
                    colors: ['#FFD700', '#FFA500', '#FF7F50', '#FA8072', '#E9967A', '#F08080', '#CD5C5C'] // æš–è‰²ç³»æ¼¸è®Š
                },
                hovertemplate: 'åˆ†æ•¸: %{label}<br>æ¬¡æ•¸: %{value} (%{percent})<extra></extra>'
            }];

            const layout = {
                title: false,
                margin: { t: 0, b: 0, l: 0, r: 0 },
                paper_bgcolor: 'white',
                showlegend: true
            };

            Plotly.newPlot('satisfactionChart', data, layout, { responsive: true, displayModeBar: false });
        }
        
        // 4.5 èª²ç¨‹å»ºè­°é¡å‹é•·æ¢åœ–
        function plotCourseTypeChart() {
             const data = [{
                x: Object.keys(typeCounts),
                y: Object.values(typeCounts),
                type: 'bar',
                marker: {
                    color: ['#FFC107', '#FFA500'] // å°ˆæ¥­æå‡ç”¨ç¥ç€ï¼Œäººæ–‡ç”¨æ©˜è‰²
                },
                hovertemplate: 'èª²ç¨‹é¡å‹: %{x}<br>å»ºè­°æ¬¡æ•¸: %{y}<extra></extra>'
            }];

            const layout = {
                title: false,
                xaxis: { title: 'èª²ç¨‹é¡å‹', fixedrange: true },
                yaxis: { title: 'å»ºè­°æ¬¡æ•¸', fixedrange: true, tick0: 0, dtick: 1, rangemode: 'tozero' },
                margin: { l: 40, r: 20, t: 20, b: 50 },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white'
            };

            Plotly.newPlot('courseTypeChart', data, layout, { responsive: true, displayModeBar: false });
        }


        // 5. é é¢åŠ è¼‰å®Œæˆå¾Œç¹ªè£½æ‰€æœ‰åœ–è¡¨
        window.onload = function() {
            plotOverallTaskChart();
            plotAverageLevelGauge();
            plotEpaDetailChart();
            plotSatisfactionChart();
            plotCourseTypeChart();
        };

        // ç¢ºä¿è¦–çª—å¤§å°æ”¹è®Šæ™‚åœ–è¡¨éŸ¿æ‡‰
        window.onresize = function() {
            Plotly.Plots.resize('overallTaskChart');
            Plotly.Plots.resize('averageLevelGauge');
            Plotly.Plots.resize('epaDetailChart');
            Plotly.Plots.resize('satisfactionChart');
            Plotly.Plots.resize('courseTypeChart');
        };

    </script>
</body>
</html>
